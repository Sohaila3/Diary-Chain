<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diary Chain - Immutable Blockchain Journal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Robust ethers loader with fallbacks -->
  <script>
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve(src);
        s.onerror = () => reject(new Error('Failed to load ' + src));
        document.head.appendChild(s);
      });
    }
    (async function ensureEthers() {
      if (window.ethers) return;
      const candidates = [
        'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js',
        'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
        'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js'
      ];
      for (const url of candidates) {
        try {
          await loadScript(url);
          if (window.ethers) return;
        } catch (e) { console.warn('ethers CDN failed:', url, e); }
      }
      console.error('All ethers CDN attempts failed');
      alert('Critical: failed to load ethers.js. Please check network/CDN blocking.');
    })();
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;500;600&display=swap');
    body { font-family: 'Lora', serif; background: linear-gradient(135deg, #fdfbf7 0%, #f5ebe0 100%); }
    .navbar-brand { font-family: 'Libre Baskerville', serif; }
    .paper-texture { background: #fffef9; box-shadow: 0 4px 6px rgba(101,67,33,.1), 0 2px 4px rgba(101,67,33,.06); }
    .ink-text { color: #2c1810; }
    .btn-primary { background: linear-gradient(135deg, #8b6f47 0%, #6b5638 100%); transition: all .3s ease; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(107,86,56,.3); }
    .entry-card { border-left: 4px solid #8b6f47; background: #fffef9; transition: all .3s ease; }
    .entry-card:hover { box-shadow: 0 8px 16px rgba(101,67,33,.15); transform: translateX(4px); }
    .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #8b6f47; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    textarea { resize: vertical; font-family: 'Lora', serif; }
    #statusMessage { max-width: 420px; right: 20px; bottom: 20px; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Navigation -->
  <nav class="paper-texture border-b-2 border-amber-800 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <h1 class="navbar-brand text-3xl font-bold ink-text">üìñ Diary Chain</h1>
        <div class="flex gap-4 items-center">
          <button id="navHome" class="px-4 py-2 ink-text hover:text-amber-800 transition font-medium">Home</button>
          <button id="navWrite" class="px-4 py-2 ink-text hover:text-amber-800 transition font-medium">Write Entry</button>
          <button id="navTimeline" class="px-4 py-2 ink-text hover:text-amber-800 transition font-medium">My Timeline</button>
          <button id="connectBtn" class="btn-primary text-white px-6 py-2 rounded-lg font-medium shadow-lg">Connect Wallet</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8">
    <!-- Home Section -->
    <div id="homeSection" class="section">
      <div class="max-w-4xl mx-auto">
        <div class="paper-texture rounded-lg p-12 text-center">
          <h2 class="text-5xl font-bold ink-text mb-6 navbar-brand">Welcome to Diary Chain</h2>
          <p class="text-xl ink-text mb-8 leading-relaxed">
            Your thoughts, forever preserved on the Celo blockchain. Write immutable diary entries that stand the test of time.
          </p>
          <div class="grid md:grid-cols-3 gap-6 mt-12">
            <div class="p-6 bg-amber-50 rounded-lg border-2 border-amber-200">
              <div class="text-4xl mb-3">üîí</div>
              <h3 class="font-bold text-lg mb-2 ink-text">Immutable</h3>
              <p class="text-sm ink-text">Once written, your entries can never be changed or deleted</p>
            </div>
            <div class="p-6 bg-amber-50 rounded-lg border-2 border-amber-200">
              <div class="text-4xl mb-3">‚è∞</div>
              <h3 class="font-bold text-lg mb-2 ink-text">Timestamped</h3>
              <p class="text-sm ink-text">Every entry is permanently marked with blockchain timestamp</p>
            </div>
            <div class="p-6 bg-amber-50 rounded-lg border-2 border-amber-200">
              <div class="text-4xl mb-3">üåç</div>
              <h3 class="font-bold text-lg mb-2 ink-text">Decentralized</h3>
              <p class="text-sm ink-text">Your journal lives on Celo's distributed network</p>
            </div>
          </div>
          <button id="ctaWrite" class="btn-primary text-white px-8 py-3 rounded-lg font-medium shadow-lg mt-8 text-lg">
            Start Writing ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Write Entry Section -->
    <div id="writeSection" class="section hidden">
      <div class="max-w-3xl mx-auto">
        <div class="paper-texture rounded-lg p-8">
          <h2 class="text-3xl font-bold ink-text mb-2 navbar-brand">Write a New Entry</h2>
          <p class="text-sm text-amber-800 mb-6 italic">Remember: Once saved to the blockchain, this entry becomes permanent and immutable.</p>

          <div class="mb-6">
            <label class="block text-sm font-medium ink-text mb-2">Your Thoughts</label>
            <textarea id="entryContent" rows="12" class="w-full px-4 py-3 border-2 border-amber-200 rounded-lg focus:outline-none focus:border-amber-600 ink-text bg-white" placeholder="What's on your mind today? Share your thoughts, experiences, or reflections..."></textarea>
            <div class="text-right text-sm text-gray-500 mt-1"><span id="charCount">0</span> characters</div>
          </div>

          <div class="flex gap-4">
            <button id="saveBtn" class="btn-primary text-white px-8 py-3 rounded-lg font-medium shadow-lg flex-1 flex items-center justify-center gap-2">
              <span>üíæ Save to Chain</span>
            </button>
            <button id="clearBtn" class="px-6 py-3 border-2 border-amber-800 ink-text rounded-lg font-medium hover:bg-amber-50 transition">Clear</button>
          </div>

          <div id="writeStatus" class="mt-4 hidden p-4 rounded-lg"></div>
        </div>
      </div>
    </div>

    <!-- Timeline Section -->
    <div id="timelineSection" class="section hidden">
      <div class="max-w-4xl mx-auto">
        <div class="paper-texture rounded-lg p-8">
          <h2 class="text-3xl font-bold ink-text mb-6 navbar-brand">My Diary Timeline</h2>
          <div id="timelineContent">
            <div class="text-center py-12 text-gray-500">
              <div class="text-6xl mb-4">üìî</div>
              <p>Connect your wallet to view your entries</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="paper-texture border-t-2 border-amber-800 mt-16">
    <div class="container mx-auto px-4 py-6 text-center ink-text">
      <p class="text-sm">Built on <span class="font-bold text-amber-800">Celo Mainnet</span> | Chain ID: 42220</p>
      <p class="text-xs mt-2 text-gray-600">Your immutable journal on the blockchain</p>
    </div>
  </footer>

  <!-- Status (global notifications) -->
  <div id="statusMessage" class="fixed bottom-6 right-6 hidden bg-white rounded-lg shadow-xl p-4 max-w-md">
    <p id="statusText" class="text-gray-800"></p>
  </div>

  <!-- App Logic -->
  <script>
    // Contract config (UPDATED ADDRESS)
    const CONTRACT_ADDRESS = "0xBC214E0B86c02D8Cba8B263b98D5011400B703a9";
    const CONTRACT_ABI = [
      {"inputs":[{"internalType":"string","name":"_content","type":"string"}],"name":"addEntry","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getEntries","outputs":[{"components":[{"internalType":"string","name":"content","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct Diary.Entry[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"}
    ];

    const CELO_MAINNET = {
      chainId: '0xa4ec',
      chainName: 'Celo Mainnet',
      nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
      rpcUrls: ['https://forno.celo.org'],
      blockExplorerUrls: ['https://explorer.celo.org']
    };

    let provider = null, signer = null, contract = null, userAddress = null;

    // Status helper
    function showStatus(message, type = 'info', ttl = 4500) {
      const statusDiv = document.getElementById('statusMessage');
      const statusText = document.getElementById('statusText');
      statusText.textContent = message;
      statusDiv.classList.remove('hidden', 'bg-blue-100', 'bg-green-100', 'bg-red-100');
      statusDiv.classList.add(type === 'success' ? 'bg-green-100' : type === 'error' ? 'bg-red-100' : 'bg-blue-100');
      clearTimeout(window._statusTimeout);
      window._statusTimeout = setTimeout(() => statusDiv.classList.add('hidden'), ttl);
    }

    // Navigation
    function showSection(section) {
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      if (section === 'home') document.getElementById('homeSection').classList.remove('hidden');
      if (section === 'write') document.getElementById('writeSection').classList.remove('hidden');
      if (section === 'timeline') {
        document.getElementById('timelineSection').classList.remove('hidden');
        if (userAddress) loadTimeline();
      }
    }

    // Connect Wallet (direct MetaMask popup, auto-switch Celo)
    async function connectWallet() {
      try {
        if (!window.ethereum) {
          showStatus('No injected wallet found. Please install MetaMask.', 'error', 6000);
          return;
        }

        showStatus('Requesting wallet connection...', 'info');
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) throw new Error('No accounts returned');
        userAddress = accounts[0];

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();

        const net = await provider.getNetwork();
        if (net.chainId !== 42220) {
          try {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CELO_MAINNET.chainId }] });
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            showStatus('Switched to Celo. Finalizing connection...', 'info', 5000);
          } catch (switchErr) {
            if (switchErr && switchErr.code === 4902) {
              try {
                await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [CELO_MAINNET] });
                showStatus('Celo added. Please approve switch and click Connect again.', 'info', 7000);
                return;
              } catch (addErr) {
                console.error('Add chain failed', addErr);
                showStatus('Failed to add Celo network.', 'error', 6000);
                return;
              }
            } else {
              console.error('Switch error', switchErr);
              showStatus('Failed to switch network. Please switch to Celo manually.', 'error', 6000);
              return;
            }
          }
        }

        // Initialize contract
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        // Update UI
        const short = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
        const btn = document.getElementById('connectBtn');
        btn.innerHTML = `‚úì ${short}`;
        btn.classList.add('bg-green-600');
        btn.disabled = true;

        showStatus('Connected to Celo Mainnet ‚úÖ', 'success', 3000);
      } catch (err) {
        console.error('connectWallet error:', err);
        showStatus('Failed to connect wallet: ' + (err.reason || err.message || err), 'error', 7000);
      }
    }

    // Save Entry
    async function saveEntry() {
      if (!contract || !userAddress) { showMessage('Please connect your wallet first!', 'error', 'writeStatus'); return; }
      const content = document.getElementById('entryContent').value.trim();
      if (!content) { showMessage('Please write something before saving!', 'error', 'writeStatus'); return; }
      if (content.length < 10) { showMessage('Entry must be at least 10 characters long.', 'error', 'writeStatus'); return; }

      const saveBtn = document.getElementById('saveBtn');
      const originalContent = saveBtn.innerHTML;

      try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="loading-spinner"></div> <span>Saving to blockchain...</span>';
        showMessage('Transaction submitted. Waiting for confirmation...', 'info', 'writeStatus');

        const tx = await contract.addEntry(content);
        await tx.wait();

        showMessage('‚úì Entry saved successfully! Your thoughts are now immutable on the blockchain.', 'success', 'writeStatus');
        document.getElementById('entryContent').value = '';
        updateCharCount();

        setTimeout(() => { document.getElementById('writeStatus').classList.add('hidden'); }, 5000);
      } catch (error) {
        console.error('Save error:', error);
        let errorMsg = 'Failed to save entry.';
        if (error.code === 4001) errorMsg = 'Transaction rejected by user.';
        else if (error.message) errorMsg = error.message;
        showMessage('Error: ' + errorMsg, 'error', 'writeStatus');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalContent;
      }
    }

    // Load Timeline
    async function loadTimeline() {
      if (!contract || !userAddress) {
        document.getElementById('timelineContent').innerHTML = `
          <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üìî</div>
            <p>Connect your wallet to view your entries</p>
          </div>`;
        return;
      }
      try {
        document.getElementById('timelineContent').innerHTML = `
          <div class="text-center py-12">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Loading your diary entries...</p>
          </div>`;
        const entries = await contract.getEntries(userAddress);

        if (!entries || entries.length === 0) {
          document.getElementById('timelineContent').innerHTML = `
            <div class="text-center py-12 text-gray-500">
              <div class="text-6xl mb-4">‚úçÔ∏è</div>
              <p class="mb-4">You haven't written any entries yet.</p>
              <button onclick="showSection('write')" class="btn-primary text-white px-6 py-2 rounded-lg font-medium shadow-lg">
                Write Your First Entry
              </button>
            </div>`;
          return;
        }

        const sorted = [...entries].reverse();
        let html = '<div class="space-y-4">';
        sorted.forEach((entry, idx) => {
          const date = new Date(entry.timestamp.toNumber() * 1000);
          const formatted = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
          html += `
            <div class="entry-card p-6 rounded-lg">
              <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2">
                  <span class="text-2xl">üìù</span>
                  <span class="font-bold text-amber-800">Entry #${entries.length - idx}</span>
                </div>
                <div class="text-sm text-gray-600">
                  <div>üïê ${formatted}</div>
                  <div class="text-xs text-gray-500 mt-1">Block TS: ${entry.timestamp.toNumber()}</div>
                </div>
              </div>
              <div class="ink-text leading-relaxed whitespace-pre-wrap">${escapeHtml(entry.content)}</div>
              <div class="mt-4 pt-4 border-t border-amber-200 text-xs text-gray-500 italic">
                üîí Immutably stored on Celo blockchain
              </div>
            </div>`;
        });
        html += '</div>';
        document.getElementById('timelineContent').innerHTML = html;
      } catch (error) {
        console.error('Load timeline error:', error);
        document.getElementById('timelineContent').innerHTML = `
          <div class="text-center py-12 text-red-600">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <p>Failed to load entries. Please try again.</p>
            <p class="text-sm mt-2">${error.message}</p>
          </div>`;
      }
    }

    // Utilities
    function updateCharCount() {
      const content = document.getElementById('entryContent').value;
      document.getElementById('charCount').textContent = content.length;
    }
    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    function showMessage(message, type, elementId = null) {
      const alertColors = { success: 'bg-green-100 border-green-500 text-green-800', error: 'bg-red-100 border-red-500 text-red-800', info: 'bg-blue-100 border-blue-500 text-blue-800' };
      if (elementId) {
        const el = document.getElementById(elementId);
        el.className = `mt-4 p-4 rounded-lg border-l-4 ${alertColors[type]}`;
        el.textContent = message;
        el.classList.remove('hidden');
      } else {
        showStatus(message, type);
      }
    }

    // Bind events
    document.getElementById('navHome').addEventListener('click', () => showSection('home'));
    document.getElementById('navWrite').addEventListener('click', () => showSection('write'));
    document.getElementById('navTimeline').addEventListener('click', () => showSection('timeline'));
    document.getElementById('ctaWrite').addEventListener('click', () => showSection('write'));
    document.getElementById('connectBtn').addEventListener('click', connectWallet);
    document.getElementById('saveBtn').addEventListener('click', saveEntry);
    document.getElementById('clearBtn').addEventListener('click', () => { document.getElementById('entryContent').value = ''; updateCharCount(); });
    document.getElementById('entryContent').addEventListener('input', updateCharCount);

    // Handle wallet changes
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', (accounts) => {
        if (!accounts || accounts.length === 0) {
          userAddress = null;
          const btn = document.getElementById('connectBtn');
          btn.innerHTML = 'Connect Wallet';
          btn.classList.remove('bg-green-600');
          btn.disabled = false;
          showStatus('Wallet disconnected', 'info', 3000);
        } else {
          location.reload();
        }
      });
      window.ethereum.on('chainChanged', () => location.reload());
    }

    // Auto-connect if already authorized
    window.addEventListener('load', async () => {
      try {
        if (window.ethereum) {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts && accounts.length > 0) await connectWallet();
        }
      } catch (e) { console.warn('auto-connect failed', e); }
    });

    // Default view
    showSection('home');
  </script>
</body>
</html>
